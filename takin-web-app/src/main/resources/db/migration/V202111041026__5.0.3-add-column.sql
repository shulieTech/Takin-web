-- /* 添加字段 */
DELIMITER $$
DROP PROCEDURE IF EXISTS `add_column` $$
CREATE PROCEDURE add_column()
BEGIN
    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene_link_relate' AND column_name = 'script_identification')
    THEN
        ALTER TABLE t_scene_link_relate
            ADD script_identification VARCHAR(255) COMMENT ' 脚本请求路径标识';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene_link_relate' AND column_name = 'script_xpath_md5')
    THEN
        ALTER TABLE t_scene_link_relate
            ADD script_xpath_md5 VARCHAR(64) COMMENT '脚本请求xpath的MD5';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene_link_relate' AND column_name = 'tenant_id')
        THEN
    ALTER TABLE t_scene_link_relate
        ADD tenant_id bigint(20) COMMENT '租户id';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene_link_relate' AND column_name = 'env_code')
        THEN
    ALTER TABLE t_scene_link_relate
        ADD env_code VARCHAR(255) COMMENT '环境code';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene' AND column_name = 'type')
    THEN
        ALTER TABLE t_scene
            ADD type tinyint(4) DEFAULT '0' COMMENT '场景类型，标识1为jmeter上传，默认0';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene' AND column_name = 'script_jmx_node')
    THEN
        ALTER TABLE t_scene
            ADD script_jmx_node longtext COMMENT '存储树状结构';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene' AND column_name = 'IS_CORE')
    THEN
        ALTER TABLE t_scene
            MODIFY COLUMN `IS_CORE` tinyint(4) NULL DEFAULT NULL COMMENT '是否核心场景 0:不是;1:是';
    END IF;




    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene' AND column_name = 'script_deploy_id')
    THEN
        ALTER TABLE t_scene
            ADD script_deploy_id bigint(20) COMMENT '脚本实例id';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene' AND column_name = 'link_relate_num')
    THEN
        ALTER TABLE t_scene
            ADD link_relate_num int(11) DEFAULT '0' COMMENT '关联节点数';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_scene' AND column_name = 'total_node_num')
    THEN
        ALTER TABLE t_scene
            ADD total_node_num int(11) DEFAULT '0' COMMENT '脚本总节点数';
    END IF;

    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_business_link_manage_table' AND column_name = 'application_name')
        THEN
    ALTER TABLE t_business_link_manage_table
        ADD application_name VARCHAR(200) COMMENT '应用名';
    END IF;



# 文件MD5
    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_file_manage' AND column_name = 'md5')
    THEN
        ALTER TABLE t_file_manage
            ADD md5 VARCHAR(255) COMMENT '文件MD5值';
    END IF;


    IF NOT EXISTS(SELECT * FROM information_schema.columns WHERE table_schema = DATABASE() AND table_name = 't_script_manage' AND column_name = 'm_version')
    THEN
        ALTER TABLE t_script_manage
            ADD m_version int(11) DEFAULT '0'  COMMENT '脚本管理-版本';
    END IF;

    UPDATE `trodb`.`t_base_config` SET `CONFIG_VALUE` = '[\n    {\n        \"title\":\"系统概览\",\n        \"key\":\"dashboard\",\n        \"icon\":\"dashboard\",\n        \"path\":\"/dashboard\",\n        \"type\":\"Item\"\n    },\n    {\n        \"icon\":\"shop\",\n        \"title\":\"仿真平台\",\n        \"key\":\"appManage\",\n        \"path\":\"/appPlatform\",\n        \"type\":\"SubMenu\",\n        \"children\":[\n            {\n                \"title\":\"应用配置\",\n                \"key\":\"appManage\",\n                \"path\":\"/appConfig\",\n                \"type\":\"SubMenu\",\n                \"children\":[\n                    {\n                        \"title\":\"新应用接入\",\n                        \"path\":\"/appAccess\",\n                        \"type\":\"Item\",\n                        \"key\":\"appManage_appAccess\"\n                    },\n                    {\n                        \"title\":\"探针列表\",\n                        \"type\":\"Item\",\n                        \"path\":\"/agentManage\",\n                        \"key\":\"appManage_agentManage\"\n                    },\n                    {\n                        \"title\":\"应用管理\",\n                        \"key\":\"appManage\",\n                        \"path\":\"/appManage\",\n                        \"type\":\"Item\",\n                        \"children\":[\n                            {\n                                \"title\":\"应用详情\",\n                                \"key\":\"appManage\",\n                                \"type\":\"NoMenu\",\n                                \"path\":\"/appManages/details\"\n                            }\n                        ]\n                    },\n                    {\n                        \"title\":\"白名单列表\",\n                        \"key\":\"appWhiteList\",\n                        \"type\":\"Item\",\n                        \"path\":\"/pro/appWhiteList\"\n                    },\n                    {\n                        \"title\":\"异常日志\",\n                        \"path\":\"/errorLog\",\n                        \"type\":\"Item\",\n                        \"key\":\"appManage_errorLog\"\n                    }\n                ]\n            },\n            {\n                \"title\":\"链路管理\",\n                \"key\":\"linkTease\",\n                \"path\":\"/linkManage\",\n                \"type\":\"SubMenu\",\n                \"children\":[\n                    {\n                        \"title\":\"入口规则\",\n                        \"type\":\"Item\",\n                        \"key\":\"configCenter_entryRule\",\n                        \"path\":\"/configCenter/entryRule\"\n                    },\n                    {\n                        \"title\":\"业务活动\",\n                        \"type\":\"Item\",\n                        \"key\":\"businessActivity\",\n                        \"path\":\"/businessActivity\",\n                        \"children\":[\n                            {\n                                \"title\":\"新增业务活动\",\n                                \"type\":\"NoMenu\",\n                                \"key\":\"businessActivity\",\n                                \"path\":\"/businessActivity/addEdit\"\n                            }\n                        ]\n                    },\n                    {\n                        \"title\":\"业务流程\",\n                        \"key\":\"businessFlow\",\n                        \"type\":\"Item\",\n                        \"path\":\"/businessFlow\",\n                        \"children\":[\n                            {\n                                \"title\":\"新增业务流程\",\n                                \"key\":\"businessFlow\",\n                                \"type\":\"NoMenu\",\n                                \"path\":\"/businessFlow/addBusinessFlow\"\n                            }\n                        ]\n                    }\n                ]\n            },\n            {\n                \"title\":\"脚本管理\",\n                \"key\":\"scriptManages\",\n                \"type\":\"SubMenu\",\n                \"path\":\"/scriptManages\",\n                \"children\":[\n                    {\n                        \"title\":\"测试脚本\",\n                        \"key\":\"scriptManage\",\n                        \"type\":\"Item\",\n                        \"path\":\"/scriptManage\",\n                        \"children\":[\n                            {\n                                \"title\":\"脚本配置\",\n                                \"key\":\"scriptManage\",\n                                \"type\":\"NoMenu\",\n                                \"path\":\"/scriptManage/scriptConfig\"\n                            },\n                            {\n                                \"key\":\"scriptManage\",\n                                \"title\":\"脚本调试详情\",\n                                \"type\":\"NoMenu\",\n                                \"path\":\"/scriptManage/scriptDebugDetail\"\n                            }\n                        ]\n                    },\n                    {\n                        \"title\":\"运维脚本\",\n                        \"type\":\"Item\",\n                        \"key\":\"scriptOperation\",\n                        \"path\":\"/scriptOperation\"\n                    }\n                ]\n            },\n            {\n                \"title\":\"调试工具\",\n                \"key\":\"debugTool\",\n                \"path\":\"/debugTool\",\n                \"type\":\"SubMenu\",\n                \"children\":[\n                    {\n                        \"title\":\"链路调试\",\n                        \"type\":\"Item\",\n                        \"key\":\"debugTool_linkDebug\",\n                        \"path\":\"/pro/debugTool/linkDebug\",\n                        \"children\":[\n                            {\n                                \"title\":\"链路调试详情\",\n                                \"type\":\"NoMenu\",\n                                \"key\":\"debugTool_linkDebug\",\n                                \"path\":\"/pro/debugTool/linkDebug/detail\"\n                            }\n                        ]\n                    }\n                ]\n            },\n            {\n                \"title\":\"数据源管理\",\n                \"type\":\"SubMenu\",\n                \"path\":\"/dataSourceManage\",\n                \"children\":[\n                    {\n                        \"title\":\"数据源配置\",\n                        \"type\":\"Item\",\n                        \"key\":\"configCenter_dataSourceConfig\",\n                        \"path\":\"/configCenter/dataSourceConfig\"\n                    }\n                ]\n            }\n        ]\n    },\n    {\n        \"title\":\"压测平台\",\n        \"icon\":\"hourglass\",\n        \"path\":\"/hourglass\",\n        \"type\":\"SubMenu\",\n        \"children\":[\n            {\n                \"title\":\"压测管理\",\n                \"type\":\"SubMenu\",\n                \"path\":\"/pressureTestManage\",\n                \"children\":[\n                    {\n                        \"title\":\"压测场景\",\n                        \"type\":\"Item\",\n                        \"key\":\"pressureTestManage_pressureTestScene\",\n                        \"path\":\"/pressureTestManage/pressureTestScene\",\n                        \"children\":[\n                            {\n                                \"title\":\"压测场景配置\",\n                                \"type\":\"NoMenu\",\n                                \"key\":\"pressureTestManage_pressureTestScene\",\n                                \"path\":\"/pressureTestManage/pressureTestScene/pressureTestSceneConfig\"\n                            }\n                        ]\n                    },\n                    {\n                        \"title\":\"压测报告\",\n                        \"type\":\"Item\",\n                        \"key\":\"pressureTestManage_pressureTestReport\",\n                        \"path\":\"/pressureTestManage/pressureTestReport\",\n                        \"children\":[\n                            {\n                                \"title\":\"压测实况\",\n                                \"type\":\"NoMenu\",\n                                \"key\":\"pressureTestManage_pressureTestReport\",\n                                \"path\":\"/pressureTestManage/pressureTestReport/pressureTestLive\"\n                            },\n                            {\n                                \"title\":\"压测报告详请\",\n                                \"type\":\"NoMenu\",\n                                \"key\":\"pressureTestManage_pressureTestReport\",\n                                \"path\":\"/pressureTestManage/pressureTestReport/details\"\n                            }\n                        ]\n                    }\n                ]\n            }\n        ]\n    },\n    {\n        \"title\":\"巡检平台\",\n        \"key\":\"patrolScreen\",\n        \"path\":\"/accountBook\",\n        \"icon\":\"account-book\",\n        \"type\":\"SubMenu\",\n        \"children\":[\n            {\n                \"title\":\"巡检大盘\",\n                \"type\":\"Item\",\n                \"key\":\"patrolScreen\",\n                \"icon\":\"account-book\",\n                \"path\":\"/pro/e2eBigScreen\"\n            },\n            {\n                \"title\":\"巡检管理\",\n                \"path\":\"/pro/missionManage\",\n                \"type\":\"Item\",\n                \"icon\":\"account-book\",\n                \"key\":\"patrolBoard\",\n                \"children\":[\n                    {\n                        \"key\":\"patrolManage\",\n                        \"title\":\"巡检场景详情\",\n                        \"type\":\"NoMenu\",\n                        \"path\":\"/pro/missionManage/sceneDetails\"\n                    }\n                ]\n            },\n            {\n                \"title\":\"瓶颈列表\",\n                \"type\":\"Item\",\n                \"key\":\"bottleneckTable\",\n                \"icon\":\"unordered-list\",\n                \"path\":\"/pro/bottleneckTable\",\n                \"children\":[\n                    {\n                        \"title\":\"瓶颈详情\",\n                        \"key\":\"bottleneckTable\",\n                        \"type\":\"NoMenu\",\n                        \"path\":\"/pro/bottleneckTable/bottleneckDetails\"\n                    }\n                ]\n            },\n            {\n                \"title\":\"瓶颈通知\",\n                \"icon\":\"menu-unfold\",\n                \"type\":\"Item\",\n                \"key\":\"exceptionNoticeManage\",\n                \"path\":\"/pro/faultNotification\"\n            },\n            {\n                \"title\":\"配置中心\",\n                \"icon\":\"setting\",\n                \"type\":\"Item\",\n                \"path\":\"/pro/setFocus\",\n                \"key\":\"bottleneckConfig\"\n            }\n        ]\n    },\n    {\n        \"icon\":\"form\",\n        \"key\":\"tracks\",\n        \"path\":\"/tracks\",\n        \"title\":\"性能监控\",\n        \"type\":\"SubMenu\",\n        \"children\":[\n            {\n                \"key\":\"traceQuery\",\n                \"title\":\"链路查询\",\n                \"path\":\"/pro/track\",\n                \"type\":\"Item\"\n            }\n        ]\n    },\n    {\n        \"icon\":\"setting\",\n        \"title\":\"设置中心\",\n        \"path\":\"/setting\",\n        \"key\":\"configCenter\",\n        \"type\":\"SubMenu\",\n        \"children\":[\n            {\n                \"title\":\"系统管理\",\n                \"key\":\"configCenter\",\n                \"path\":\"/configCenter\",\n                \"type\":\"SubMenu\",\n                \"children\":[\n                    {\n                        \"title\":\"系统信息\",\n                        \"key\":\"system_info\",\n                        \"type\":\"Item\",\n                        \"path\":\"/configCenter/systemInfo\"\n                    },\n                    {\n                        \"title\":\"全局配置\",\n                        \"type\":\"Item\",\n                        \"key\":\"center_config\",\n                        \"path\":\"/configCenter/globalConfig\",\n                        \"children\":[\n                            {\n                                \"path\":\"\",\n                                \"title\":\"压测开关\",\n                                \"type\":\"NoMenu\",\n                                \"key\":\"configCenter_pressureMeasureSwitch\"\n                            },\n                            {\n                                \"path\":\"\",\n                                \"title\":\"白名单开关\",\n                                \"type\":\"NoMenu\",\n                                \"key\":\"configCenter_whitelistSwitch\"\n                            }\n                        ]\n                    },\n                    {\n                        \"title\":\"中间件库管理\",\n                        \"type\":\"Item\",\n                        \"key\":\"configCenter_middlewareManage\",\n                        \"path\":\"/configCenter/middlewareManage\"\n                    },\n                    {\n                        \"title\":\"开关配置\",\n                        \"type\":\"Item\",\n                        \"key\":\"configCenter_bigDataConfig\",\n                        \"path\":\"/configCenter/bigDataConfig\"\n                    },\n                    {\n                        \"path\":\"/admin\",\n                        \"title\":\"探针版本管理\",\n                        \"type\":\"Item\",\n                        \"key\":\"admins_admin\"\n                    },\n                    {\n                        \"type\":\"Item\",\n                        \"title\":\"仿真系统配置\",\n                        \"path\":\"/simulationConfig\",\n                        \"key\":\"admins_simulationConfig\"\n                    },\n                    {\n                        \"title\":\"流量账户\",\n                        \"key\":\"flowAccount\",\n                        \"type\":\"Item\",\n                        \"path\":\"/pro/flowAccount\"\n                    }\n                ]\n            },\n            {\n                \"title\":\"权限管理\",\n                \"type\":\"SubMenu\",\n                \"path\":\"/authorityManage\",\n                \"key\":\"configCenter_authorityConfig\",\n                \"children\":[\n                    {\n                        \"title\":\"权限配置中心\",\n                        \"type\":\"Item\",\n                        \"key\":\"configCenter_authorityConfig\",\n                        \"path\":\"/pro/configCenter/authorityConfig\"\n                    },\n                    {\n                        \"title\":\"操作日志\",\n                        \"type\":\"Item\",\n                        \"key\":\"configCenter_operationLog\",\n                        \"path\":\"/pro/configCenter/operationLog\"\n                    }\n                ]\n            }\n        ]\n    }\n]' WHERE `CONFIG_CODE` = 'ALL_MENU' AND `env_code` = 'system' AND `tenant_id` = -1;
END $$
DELIMITER ;
CALL add_column;
